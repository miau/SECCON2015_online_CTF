#include <stdlib.h>
#include "pin.H"

VOID check_syscall(ADDRINT rax, ADDRINT rdi)
{
    static int is_syscall_impossible = 0;
    if(is_syscall_impossible){
        PIN_ERROR("invalid syscall\n");
        exit(-1);
    }else{
        if(rax == 3 && rdi == 31337){   // sys_close(31337)
            is_syscall_impossible = ~0;
        }
    }
}

VOID insert_hooks(INS ins, VOID *val)
{
    if(INS_IsSyscall(ins)){
        // check syscall
        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)check_syscall,
            IARG_REG_VALUE, REG_RAX, IARG_REG_VALUE, REG_RDI, IARG_END);
    }
}

int main(int argc, char *argv[])
{
    PIN_Init(argc, argv);
    INS_AddInstrumentFunction(insert_hooks, NULL);
    PIN_StartProgram();
    
    return 0;
}
