FROM debian:jessie
MAINTAINER iwamura

# Modify sources.list for using mirror site
RUN (echo deb http://cdn.debian.net/debian jessie main; \
     echo deb http://cdn.debian.net/debian jessie-updates main; \
     echo deb http://security.debian.org jessie/updates main) > /etc/apt/sources.list

# Install packages
RUN apt-get update && apt-get -y --no-install-recommends install \
        locales \
        curl \
        ca-certificates \
        build-essential \
        xinetd \
        python \
        nasm \
        vim-nox \
        sudo \
        strace \
        gdb \
    &&\
    rm -r /var/cache/apt /var/lib/apt/lists

# Setup Japanese locale
RUN echo "ja_JP.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen && \
    update-locale LANG=ja_JP.UTF-8
ENV LANG ja_JP.UTF-8
ENV LANGUAGE ja_JP.UTF-8
ENV LC_ALL ja_JP.UTF-8

# Create user and working directory to build
RUN useradd pinhole &&\
    echo "pinhole ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/pinhole &&\
    mkdir -p /opt/pinhole-build && chown pinhole.pinhole /opt/pinhole-build &&\
    mkdir -p /opt/pinhole-root && chown pinhole.pinhole /opt/pinhole-root
USER pinhole

# Download and extract Intel Pin
RUN cd /opt/pinhole-build &&\
    curl -sf -o pin-2.14-71313-gcc.4.4.7-linux.tar.gz -L http://software.intel.com/sites/landingpage/pintool/downloads/pin-2.14-71313-gcc.4.4.7-linux.tar.gz &&\
    tar -xf pin-2.14-71313-gcc.4.4.7-linux.tar.gz &&\
    rm -f pin-2.14-71313-gcc.4.4.7-linux.tar.gz
ENV PIN_ROOT=/opt/pinhole-build/pin-2.14-71313-gcc.4.4.7-linux

# Create root directory for chroot
RUN cd /opt/pinhole-root &&\
    mkdir -p bin lib/x86_64-linux-gnu lib64 usr/lib/x86_64-linux-gnu/ &&\
    cp /opt/pinhole-build/pin-2.14-71313-gcc.4.4.7-linux/intel64/bin/pinbin bin &&\
    for f in libc.so.6 libdl.so.2 libgcc_s.so.1 libm.so.6; \
        do cp /lib/x86_64-linux-gnu/$f lib/x86_64-linux-gnu; \
    done &&\
    cp /lib64/ld-linux-x86-64.so.2 lib64 &&\
    cp /usr/lib/x86_64-linux-gnu/libstdc++.so.6 usr/lib/x86_64-linux-gnu/

ADD make-all.sh /opt/

#CMD ["xinetd", "-dontfork"]
CMD ["/bin/bash"]

