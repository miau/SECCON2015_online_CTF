#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>

#define NODE_TYPE_LEAF 'L'
#define NODE_TYPE_INTERNAL 'I'

#define ERROR(msg) fprintf(stderr, "%s(%d): %s\n", __FILE__, __LINE__, msg)

typedef struct node {
    char        type;
    struct node *left;
    struct node *right;
} node_t, *pnode_t;

pnode_t construct_tree(char *flag)
{
    pnode_t root, leaf, cursor, next;
    int     i, j;

    cursor = root = (pnode_t)calloc(1, sizeof(node_t));
    for(i = 0; i < strlen(flag); i++){
        for(j = 0; j < 8; j++){
            cursor->type = NODE_TYPE_INTERNAL;
            next = (pnode_t)calloc(1, sizeof(node_t));
            if(((unsigned char)flag[i] >> (7 - j)) & 1){
                cursor->left = next;
            }else{
                cursor->right = next;
            }
            cursor = next;
        }
    }
    cursor->type = NODE_TYPE_LEAF;

    return root;
}

void read_flag(size_t size, char *flag)
{
    int     fd;
    char    ch;

    if((fd = open("flag.txt", O_RDONLY)) < 0){
        ERROR("No flag.txt");
        exit(-1);
    }
    while(size--){
        if(read(fd, &ch, 1) <= 0 || ch == '\n'){
            break;
        }
        *flag++ = ch;
    }
    close(fd);
}

int main(int argc, char **argv)
{
    pnode_t root;
    char    flag[64];
    char    buf[4096];
    size_t  len, rslt;

    setbuf(stdin, NULL);
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);

    memset(flag, 0x00, sizeof(flag));
    read_flag(sizeof(flag) - 1, flag);
    root = construct_tree(flag);
    printf("%016llx\n", root);
    memset(flag, 0xCC, sizeof(flag));
    while(1){
        rslt = fread(&len, sizeof(len), 1, stdin);
        if(rslt != 1 || len > sizeof(buf)){
            ERROR("Invalid input");
            exit(-1);
        }
        if(len == 0){
            break;
        }
        rslt = fread(buf, 1, len, stdin);
        if(rslt != len){
            ERROR("Invalid input");
            exit(-1);
        }
        printf(buf);
    }

    return 0;
}
